<!DOCTYPE html>
<html>
<head>
    <title>GaadiMech CRM Portal - Followups</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 8px; }
        a { color: #0066cc; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .search-section { margin-bottom: 30px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input[type="date"] { padding: 5px; font-size: 16px; }
        .button-group { margin-top: 15px; }
        .search-button { padding: 5px 15px; font-size: 16px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <a href="{{ url_for('index') }}">GaadiMech CRM Portal</a>
        </h1>
        
        <nav>
            <ul>
                <li><a href="{{ url_for('index') }}">Add Lead</a></li>
                <li><a href="{{ url_for('followups') }}">View Followups</a></li>
                <li>Welcome, {{ current_user.name }}</li>
                <li><a href="{{ url_for('logout') }}">Logout</a></li>
            </ul>
        </nav>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="search-section">
            <h2>Search Followups</h2>
            <form method="GET" action="{{ url_for('followups') }}">
                {% if current_user.is_admin %}
                <div class="form-group">
                    <label>Team Member</label>
                    <select name="team_member_id">
                        <option value="">All Team Members</option>
                        {% for member in team_members %}
                            <option value="{{ member.id }}" {% if selected_member_id|string == member.id|string %}selected{% endif %}>
                                {{ member.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                
                <div class="form-group">
                    <label>Followup Date</label>
                    <input type="date" name="date" value="{{ request.args.get('date', '') }}">
                </div>

                <div class="button-group">
                    <button type="submit" class="search-button">Search</button>
                    <a href="{{ url_for('followups') }}">Reset</a>
                </div>
            </form>
        </div>

        <h2>
            {% if current_user.is_admin %}
                {% if selected_member_id %}
                    {% for member in team_members %}
                        {% if member.id|string == selected_member_id|string %}
                            Leads for {{ member.name }}
                        {% endif %}
                    {% endfor %}
                {% else %}
                    All Team Leads
                {% endif %}
            {% else %}
                Your Leads
            {% endif %}
        </h2>

        <table>
            <thead>
                <tr>
                    <th>Customer Name</th>
                    <th>Mobile</th>
                    <th>Followup Date</th>
                    <th>Remarks</th>
                    <th>Created At</th>
                    {% if current_user.is_admin %}
                        <th>Created By</th>
                    {% endif %}
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if followups %}
                    {% for followup in followups %}
                        <tr>
                            <td>{{ followup.customer_name }}</td>
                            <td>
                                <a href="javascript:void(0);" onclick="copyToDialer('{{ followup.mobile }}')">
                                    {{ followup.mobile }}
                                </a>
                            </td>
                            <td>{{ followup.followup_date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ followup.remarks }}</td>
                            <td>{{ followup.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            {% if current_user.is_admin %}
                                <td>{{ followup.creator.name }}</td>
                            {% endif %}
                            <td>
                                {% if current_user.is_admin or followup.creator_id == current_user.id %}
                                    <a href="{{ url_for('edit_lead', lead_id=followup.id) }}">Edit</a>
                                    <button onclick="deleteLead({{ followup.id }})">Delete</button>
                                    <a href="javascript:void(0);" onclick="openWhatsApp('{{ followup.mobile }}')">WhatsApp</a>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="{% if current_user.is_admin %}7{% else %}6{% endif %}">
                            No followups found for the selected criteria
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <script>
        function deleteLead(leadId) {
            if (confirm('Are you sure you want to delete this lead?')) {
                fetch(`/delete_lead/${leadId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message || 'Error deleting lead');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting lead');
                });
            }
        }

        function copyToDialer(mobile) {
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                window.location.href = `tel:${mobile}`;
            } else {
                navigator.clipboard.writeText(mobile)
                    .then(() => alert('Mobile number copied to clipboard'))
                    .catch(err => console.error('Failed to copy:', err));
            }
        }

        function openWhatsApp(mobile) {
            fetch(`/open_whatsapp/${mobile}`)
                .then(response => response.json())
                .then(data => {
                    window.open(data.url, '_blank');
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error opening WhatsApp');
                });
        }
    </script>
</body>
</html>